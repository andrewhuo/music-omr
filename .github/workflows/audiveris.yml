name: Audiveris OMR + Measure Label Debug

on:
  workflow_dispatch:
    inputs:
      pdf_gcs_uri:
        description: "GCS URI to input PDF (gs://music-omr-bucket-777135743132/input/test.pdf)"
        required: true
        type: string

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      OUTPUT_PREFIX: "gs://music-omr-bucket-777135743132/output"

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true

      - name: Set up Google Cloud SDK (apt)
        run: |
          set -euo pipefail
          if command -v gcloud >/dev/null 2>&1; then
            gcloud --version
            exit 0
          fi
          sudo apt-get update -y
          sudo apt-get install -y apt-transport-https ca-certificates gnupg curl
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y
          sudo apt-get install -y google-cloud-cli
          gcloud --version

      - name: Configure gcloud auth for gsutil
        run: |
          set -euo pipefail
          if [[ -z "${GOOGLE_APPLICATION_CREDENTIALS:-}" ]]; then
            echo "ERROR: GOOGLE_APPLICATION_CREDENTIALS not set"
            exit 1
          fi
          echo "GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}"
          echo "CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=${GOOGLE_APPLICATION_CREDENTIALS}" >> "$GITHUB_ENV"
          gcloud auth login --cred-file="${GOOGLE_APPLICATION_CREDENTIALS}"
          gcloud auth list

      - name: Show run context
        run: |
          set -euo pipefail
          echo "repo: $GITHUB_REPOSITORY"
          echo "sha:  $GITHUB_SHA"
          echo "pdf_gcs_uri: ${{ inputs.pdf_gcs_uri }}"
          echo "output_prefix: ${OUTPUT_PREFIX}"

      - name: Download input PDF
        run: |
          set -euo pipefail
          mkdir -p /tmp/work
          gsutil cp "${{ inputs.pdf_gcs_uri }}" /tmp/work/input.pdf
          ls -lh /tmp/work/input.pdf

      - name: Run Audiveris OMR
        run: |
          set -euo pipefail
          mkdir -p /tmp/work/audiveris_out
          docker run --rm \
            -v /tmp/work:/work \
            toprock/audiveris:latest \
            /audiveris-extract/bin/Audiveris -batch -export -output /work/audiveris_out /work/input.pdf || true

          echo "Audiveris outputs:"
          find /tmp/work/audiveris_out -maxdepth 4 -type f -print || true
          echo "MusicXML candidates:"
          ls -lh /tmp/work/audiveris_out/input || true
          find /tmp/work/audiveris_out -maxdepth 4 -type f \( -name "*.mxl" -o -name "*.musicxml" -o -name "*.xml" \) -print || true

      - name: Validate OMR and print archive debug
        run: |
          set -euo pipefail
          OMR="/tmp/work/audiveris_out/input/input.omr"
          if [[ ! -f "$OMR" ]]; then
            echo "ERROR: missing $OMR"
            find /tmp/work/audiveris_out -maxdepth 4 -type f -print || true
            exit 1
          fi

          echo "Top of OMR archive listing:"
          unzip -l "$OMR" | sed -n '1,220p'

          echo "Audiveris logs (tail):"
          for f in /tmp/work/audiveris_out/input/*.log; do
            [[ -f "$f" ]] || continue
            echo "--- $f (last 120 lines) ---"
            tail -n 120 "$f" || true
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install opencv-python==4.12.0.88 pymupdf==1.20.0 numpy lxml==5.3.0

      - name: Annotate PDF (guides + measure labels) with verbose debug
        env:
          DEBUG_GUIDES: "0"
          ENABLE_MEASURE_LABELS: "1"
          MEASURE_LABEL_MODE: "staff_start"
          MEASURE_SOURCE_POLICY: "mxl_strict"
          MXL_PARSER_POLICY: "auto"
          MXL_SANITIZE_PREFIXES: "1"
          DEBUG_MEASURE_LABELS: "1"
          DEBUG_MEASURE_MARKERS: "0"
          MEASURE_MAPPING_DEBUG_PATH: "/tmp/work/measure_mapping_debug.json"
        run: |
          set -euo pipefail
          python -u parser-api/annotate_guides_from_omr.py \
            /tmp/work/input.pdf \
            /tmp/work/audiveris_out/input/input.omr \
            /tmp/work/annotated.pdf
          ls -lh /tmp/work/annotated.pdf

      - name: Sanity-check output PDF
        run: |
          set -euo pipefail
          python - << 'PY'
          import fitz

          in_doc = fitz.open('/tmp/work/input.pdf')
          out_doc = fitz.open('/tmp/work/annotated.pdf')
          print('input_pages=', in_doc.page_count)
          print('output_pages=', out_doc.page_count)
          if in_doc.page_count != out_doc.page_count:
            raise SystemExit('ERROR: output page count mismatch')
          PY

      - name: Upload outputs and debug artifacts
        run: |
          set -euo pipefail
          gsutil cp /tmp/work/annotated.pdf "${OUTPUT_PREFIX}/annotated.pdf"
          gsutil cp /tmp/work/measure_mapping_debug.json "${OUTPUT_PREFIX}/measure_mapping_debug.json"
          echo "uploaded_latest=${OUTPUT_PREFIX}/annotated.pdf"
          echo "uploaded_mapping_debug=${OUTPUT_PREFIX}/measure_mapping_debug.json"

          echo "Upload complete"
