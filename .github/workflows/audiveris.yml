name: Audiveris OMR + Measure Label Debug

on:
  workflow_dispatch:
    inputs:
      pdf_gcs_uri:
        description: "GCS URI to input PDF (gs://music-omr-bucket-777135743132/input/test.pdf)"
        required: true
        type: string

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      OUTPUT_PREFIX: "gs://music-omr-bucket-777135743132/output"

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true

      - name: Set up Google Cloud SDK (apt)
        run: |
          set -euo pipefail
          if command -v gcloud >/dev/null 2>&1; then
            gcloud --version
            exit 0
          fi
          sudo apt-get update -y
          sudo apt-get install -y apt-transport-https ca-certificates gnupg curl
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y
          sudo apt-get install -y google-cloud-cli
          gcloud --version

      - name: Configure gcloud auth for gsutil
        run: |
          set -euo pipefail
          if [[ -z "${GOOGLE_APPLICATION_CREDENTIALS:-}" ]]; then
            echo "ERROR: GOOGLE_APPLICATION_CREDENTIALS not set"
            exit 1
          fi
          echo "GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS}"
          echo "CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=${GOOGLE_APPLICATION_CREDENTIALS}" >> "$GITHUB_ENV"
          gcloud auth login --cred-file="${GOOGLE_APPLICATION_CREDENTIALS}"
          gcloud auth list

      - name: Show run context
        run: |
          set -euo pipefail
          echo "repo: $GITHUB_REPOSITORY"
          echo "sha:  $GITHUB_SHA"
          echo "pdf_gcs_uri: ${{ inputs.pdf_gcs_uri }}"
          echo "output_prefix: ${OUTPUT_PREFIX}"

      - name: Download input PDF
        run: |
          set -euo pipefail
          mkdir -p /tmp/work
          gsutil cp "${{ inputs.pdf_gcs_uri }}" /tmp/work/input.pdf
          ls -lh /tmp/work/input.pdf

      - name: Run Audiveris OMR
        run: |
          set -euo pipefail
          mkdir -p /tmp/work/audiveris_out

          run_omr() {
            local image="$1"
            echo "Audiveris image: $image"
            docker run --rm \
              -v /tmp/work:/work \
              "$image" \
              sh -c 'AUDI_BIN="/audiveris-extract/bin/Audiveris"; if [ -x /audiveris/bin/Audiveris ]; then AUDI_BIN="/audiveris/bin/Audiveris"; fi; echo "Audiveris bin: $AUDI_BIN"; $AUDI_BIN -batch -export -output /work/audiveris_out /work/input.pdf' || true
          }

          check_mxl() {
          python - <<'PY'
          import glob, zipfile, xml.etree.ElementTree as ET
          def local(tag):
              return tag.split('}',1)[-1] if '}' in tag else tag
          def count_parts_measures(root):
              parts = [el for el in root.iter() if local(el.tag) == 'part']
              measures = [el for el in root.iter() if local(el.tag) == 'measure']
              return len(parts), len(measures)
          
          cands = sorted(glob.glob('/tmp/work/audiveris_out/input/*.mxl'))
          if not cands:
              print("MXL_CHECK: no .mxl found")
              raise SystemExit(2)
          mxl = cands[0]
          with zipfile.ZipFile(mxl, 'r') as z:
              members = []
              for name in z.namelist():
                  if name.startswith('META-INF/'):
                      continue
                  if not (name.lower().endswith('.xml') or name.lower().endswith('.musicxml')):
                      continue
                  try:
                      root = ET.fromstring(z.read(name))
                  except Exception:
                      continue
                  parts, measures = count_parts_measures(root)
                  members.append((name, local(root.tag), parts, measures))
              if not members:
                  print("MXL_CHECK: no xml members")
                  raise SystemExit(3)
              members.sort(key=lambda x: (x[3], x[2]), reverse=True)
              name, root, parts, measures = members[0]
              print(f"MXL_CHECK: mxl={mxl} member={name} root={root} parts={parts} measures={measures}")
              if parts == 0 or measures == 0:
                  raise SystemExit(1)
          PY
          }

          run_omr toprock/audiveris:latest
          if ! check_mxl; then
            echo "MusicXML export has no parts/measures. Retrying with full Audiveris image."
            rm -rf /tmp/work/audiveris_out
            mkdir -p /tmp/work/audiveris_out
            run_omr audiveris/audiveris
            check_mxl
          fi

          echo "Audiveris outputs:"
          find /tmp/work/audiveris_out -maxdepth 4 -type f -print || true
          echo "MusicXML candidates:"
          ls -lh /tmp/work/audiveris_out/input || true
          find /tmp/work/audiveris_out -maxdepth 4 -type f \( -name "*.mxl" -o -name "*.musicxml" -o -name "*.xml" \) -print || true

      - name: MusicXML debug (member list + head)
        run: |
          set -euo pipefail
          MXL="/tmp/work/audiveris_out/input/input.mvt1.mxl"
          if [[ ! -f "$MXL" ]]; then
            echo "No MXL at $MXL"
            find /tmp/work/audiveris_out -maxdepth 4 -type f -print || true
            exit 0
          fi
          echo "=== MXL member list (xml/musicxml only) ==="
          unzip -l "$MXL" | grep -E '\.xml$|\.musicxml$' || true
          echo "=== Head of input.mvt1.xml (if present) ==="
          unzip -p "$MXL" input.mvt1.xml | head -n 200 || true

      - name: Validate OMR and print archive debug
        run: |
          set -euo pipefail
          OMR="/tmp/work/audiveris_out/input/input.omr"
          if [[ ! -f "$OMR" ]]; then
            echo "ERROR: missing $OMR"
            find /tmp/work/audiveris_out -maxdepth 4 -type f -print || true
            exit 1
          fi

          echo "Top of OMR archive listing:"
          unzip -l "$OMR" | sed -n '1,220p'

          echo "Audiveris logs (tail):"
          for f in /tmp/work/audiveris_out/input/*.log; do
            [[ -f "$f" ]] || continue
            echo "--- $f (last 120 lines) ---"
            tail -n 120 "$f" || true
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install opencv-python==4.12.0.88 pymupdf==1.20.0 numpy lxml==5.3.0

      - name: Annotate PDF (guides + measure labels) with verbose debug
        env:
          DEBUG_GUIDES: "0"
          ENABLE_MEASURE_LABELS: "1"
          MEASURE_LABEL_MODE: "staff_start"
          MEASURE_SOURCE_POLICY: "mxl_strict"
          MXL_PARSER_POLICY: "auto"
          MXL_SANITIZE_PREFIXES: "1"
          DEBUG_MEASURE_LABELS: "1"
          DEBUG_MEASURE_MARKERS: "0"
          MEASURE_MAPPING_DEBUG_PATH: "/tmp/work/measure_mapping_debug.json"
        run: |
          set -euo pipefail
          python -u parser-api/annotate_guides_from_omr.py \
            /tmp/work/input.pdf \
            /tmp/work/audiveris_out/input/input.omr \
            /tmp/work/annotated.pdf
          ls -lh /tmp/work/annotated.pdf

      - name: Sanity-check output PDF
        run: |
          set -euo pipefail
          python - << 'PY'
          import fitz

          in_doc = fitz.open('/tmp/work/input.pdf')
          out_doc = fitz.open('/tmp/work/annotated.pdf')
          print('input_pages=', in_doc.page_count)
          print('output_pages=', out_doc.page_count)
          if in_doc.page_count != out_doc.page_count:
            raise SystemExit('ERROR: output page count mismatch')
          PY

      - name: Upload outputs and debug artifacts
        run: |
          set -euo pipefail
          gsutil cp /tmp/work/annotated.pdf "${OUTPUT_PREFIX}/annotated.pdf"
          gsutil cp /tmp/work/measure_mapping_debug.json "${OUTPUT_PREFIX}/measure_mapping_debug.json"
          echo "uploaded_latest=${OUTPUT_PREFIX}/annotated.pdf"
          echo "uploaded_mapping_debug=${OUTPUT_PREFIX}/measure_mapping_debug.json"

          echo "Upload complete"
