name: Audiveris OMR Processor

on:
  workflow_dispatch:
    inputs:
      pdf_gcs_uri:
        description: 'GCS URI of the input PDF'
        required: true
      output_gcs_prefix:
        description: 'GCS path prefix for MusicXML output'
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  run-audiveris:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

    - name: Set up Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v3
      with:
        version: '>= 416.0.0'

    - name: Download input PDF from GCS
      run: |
        echo "Downloading PDF from ${{ github.event.inputs.pdf_gcs_uri }}"
        gsutil cp "${{ github.event.inputs.pdf_gcs_uri }}" input.pdf

    - name: Convert with Audiveris Docker image
      run: |
        mkdir -p audiveris/input audiveris/output
        mv input.pdf audiveris/input/
        docker pull toprock/audiveris
        docker run --rm \
          -v "$(pwd)/audiveris/input":/input \
          -v "$(pwd)/audiveris/output":/output \
          toprock/audiveris
        ls audiveris/output

    - name: Upload MusicXML to GCS
      uses: google-github-actions/upload-cloud-storage@v3
      with:
        path: "audiveris/output/*.mxl"
        destination: "${{ github.event.inputs.output_gcs_prefix }}"

    - name: Install Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install parser library music21
      run: |
        python -m pip install --upgrade pip
        python -m pip install music21==9.1

    - name: Test MusicXML parsing
      run: |
        python parser-api/parse_musicxml.py audiveris/output/output.musicxml || \
        python parser-api/parse_musicxml.py audiveris/output/output.mxl

    - name: Extract unique measure list
      run: |
        python parser-api/parse_measures_unique.py audiveris/output/output.musicxml || \
        python parser-api/parse_measures_unique.py audiveris/output/output.mxl
