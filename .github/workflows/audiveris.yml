name: Audiveris OMR + Measure Label Debug

on:
  workflow_dispatch:
    inputs:
      pdf_gcs_uri:
        description: "GCS URI to input PDF (gs://music-omr-bucket-777135743132/input/test.pdf)"
        required: true
        type: string

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      OUTPUT_PREFIX: "gs://music-omr-bucket-777135743132/output"
      DEBUG_SHEET: "sheet#3/sheet#3.xml"
      DEBUG_STAFF: "5"

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          version: ">= 363.0.0"

      - name: Show run context
        run: |
          set -euo pipefail
          echo "repo: $GITHUB_REPOSITORY"
          echo "sha:  $GITHUB_SHA"
          echo "pdf_gcs_uri: ${{ inputs.pdf_gcs_uri }}"
          echo "output_prefix: ${OUTPUT_PREFIX}"
          echo "DEBUG_SHEET=${DEBUG_SHEET}"
          echo "DEBUG_STAFF=${DEBUG_STAFF}"

      - name: Download input PDF
        run: |
          set -euo pipefail
          mkdir -p /tmp/work /tmp/work/debug
          gsutil cp "${{ inputs.pdf_gcs_uri }}" /tmp/work/input.pdf
          ls -lh /tmp/work/input.pdf

      - name: Run Audiveris OMR
        run: |
          set -euo pipefail
          mkdir -p /tmp/work/audiveris_out
          docker run --rm \
            -v /tmp/work:/work \
            toprock/audiveris:latest \
            /audiveris-extract/bin/Audiveris -batch -export -output /work/audiveris_out /work/input.pdf || true

          echo "Audiveris outputs:"
          find /tmp/work/audiveris_out -maxdepth 4 -type f -print || true

      - name: Validate OMR and print archive debug
        run: |
          set -euo pipefail
          OMR="/tmp/work/audiveris_out/input/input.omr"
          if [[ ! -f "$OMR" ]]; then
            echo "ERROR: missing $OMR"
            find /tmp/work/audiveris_out -maxdepth 4 -type f -print || true
            exit 1
          fi

          echo "Top of OMR archive listing:"
          unzip -l "$OMR" | sed -n '1,220p'

          echo "Audiveris logs (tail):"
          for f in /tmp/work/audiveris_out/input/*.log; do
            [[ -f "$f" ]] || continue
            echo "--- $f (last 120 lines) ---"
            tail -n 120 "$f" || true
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install opencv-python==4.12.0.88 pymupdf==1.20.0 numpy

      - name: OMR structure debug (logs + artifact)
        run: |
          set -euo pipefail
          python - << 'PY'
          import json
          import os
          import re
          import xml.etree.ElementTree as ET
          import zipfile

          omr = "/tmp/work/audiveris_out/input/input.omr"
          sheet_re = re.compile(r"^sheet#(\d+)/sheet#\1\.xml$")
          out = []

          with zipfile.ZipFile(omr, "r") as z:
            sheets = sorted([n for n in z.namelist() if sheet_re.match(n)], key=lambda n: int(sheet_re.match(n).group(1)))
            print(f"sheet_xml_count={len(sheets)}")

            for path in sheets:
              root = ET.fromstring(z.read(path))
              pages = root.findall("page")
              page_rows = []
              print(f"sheet={path} pages={len(pages)}")

              for page in pages:
                systems = page.findall(".//system")
                staff_count = 0
                barline_count = 0
                for sys_el in systems:
                  staves = sys_el.findall(".//staff")
                  staff_count += len(staves)
                  inters = sys_el.find(".//sig/inters")
                  if inters is not None:
                    for el in inters.iter():
                      if (el.tag or "").lower() == "barline":
                        barline_count += 1
                print(f"  page_id={page.get('id')} systems={len(systems)} staves={staff_count} barlines={barline_count}")
                page_rows.append({
                  "page_id": page.get("id"),
                  "systems": len(systems),
                  "staves": staff_count,
                  "barlines": barline_count,
                })

              out.append({"sheet": path, "pages": page_rows})

          os.makedirs("/tmp/work/debug", exist_ok=True)
          with open("/tmp/work/debug/omr_debug_summary.json", "w") as f:
            json.dump(out, f, indent=2)
          print("wrote /tmp/work/debug/omr_debug_summary.json")
          PY

      - name: Annotate PDF (guides + measure labels) with verbose debug
        env:
          DEBUG_GUIDES: "1"
          DEBUG_GUIDES_SHEET: "${{ env.DEBUG_SHEET }}"
          DEBUG_GUIDES_STAFF_ID: "${{ env.DEBUG_STAFF }}"
          DEBUG_GUIDES_DUMP_INTERS: "1"
          ENABLE_MEASURE_LABELS: "1"
          MEASURE_LABEL_MODE: "staff_start"
          DEBUG_MEASURE_LABELS: "1"
          DEBUG_MEASURE_MARKERS: "0"
        run: |
          set -euo pipefail
          python -u parser-api/annotate_guides_from_omr.py \
            /tmp/work/input.pdf \
            /tmp/work/audiveris_out/input/input.omr \
            /tmp/work/annotated.pdf
          ls -lh /tmp/work/annotated.pdf

      - name: Sanity-check output PDF
        run: |
          set -euo pipefail
          python - << 'PY'
          import fitz

          in_doc = fitz.open('/tmp/work/input.pdf')
          out_doc = fitz.open('/tmp/work/annotated.pdf')
          print('input_pages=', in_doc.page_count)
          print('output_pages=', out_doc.page_count)
          if in_doc.page_count != out_doc.page_count:
            raise SystemExit('ERROR: output page count mismatch')

          # Basic text extraction probe; numbers may or may not be extractable depending on PDF internals.
          for i in range(min(3, out_doc.page_count)):
            txt = out_doc[i].get_text('text')
            print(f'page_{i+1}_text_probe_has_digit1=', ('1' in txt))
          PY

      - name: Upload outputs and debug artifacts
        run: |
          set -euo pipefail
          RUN_OUT="${OUTPUT_PREFIX}/runs/${GITHUB_RUN_ID}/annotated.pdf"
          gsutil cp /tmp/work/annotated.pdf "${OUTPUT_PREFIX}/annotated.pdf"
          gsutil cp /tmp/work/annotated.pdf "${RUN_OUT}"
          echo "uploaded_latest=${OUTPUT_PREFIX}/annotated.pdf"
          echo "uploaded_run_specific=${RUN_OUT}"

          if [ -d /tmp/work/debug ]; then
            gsutil -m cp -r /tmp/work/debug "${OUTPUT_PREFIX}/debug"
          fi

          if [ -d /tmp/work/audiveris_out ] && [ "$(ls -A /tmp/work/audiveris_out)" ]; then
            gsutil -m cp -r /tmp/work/audiveris_out "${OUTPUT_PREFIX}/audiveris_out"
          fi

          echo "Upload complete"
