name: Audiveris OMR + Barline Detection Test

on:
  workflow_dispatch:
    inputs:
      pdf_gcs_uri:
        description: "GCS URI to your input PDF (gs://music-omr-bucket-777135743132/input/test.pdf)"
        required: true
        type: string

      # Optional: override output prefix (defaults to gs://.../output)
      output_gcs_prefix:
        description: "GCS prefix to upload outputs (gs://.../output)"
        required: false
        type: string
        default: "gs://music-omr-bucket-777135743132/output"

      # ===== Debug toggles =====
      debug_guides:
        description: "Emit [DBG] guide placement logs"
        required: false
        type: boolean
        default: false

      debug_measures:
        description: "Emit [DBG] measure/system logs"
        required: false
        type: boolean
        default: false

      debug_dump_inters:
        description: "When DEBUG_GUIDES is on, dump nearby symbol boxes (can be noisy)"
        required: false
        type: boolean
        default: false

      # Optional targeting to keep logs small
      debug_sheet:
        description: "Filter debug to one sheet xml path substring (ex: sheet#1/sheet#1.xml). Leave blank to auto-pick."
        required: false
        type: string
        default: ""

      debug_staff:
        description: "Filter guide debug to one staff id (string). Leave blank for all."
        required: false
        type: string
        default: ""

      debug_measures_sys:
        description: "Filter measure debug to one system id. Leave blank for all."
        required: false
        type: string
        default: ""

jobs:
  pipeline:
    runs-on: ubuntu-latest

    env:
      BUCKET: "gs://music-omr-bucket-777135743132"
      OUTPUT_PREFIX: "${{ inputs.output_gcs_prefix }}"

      # ====== Debug knobs passed into annotate_guides_from_omr.py ======
      DEBUG_GUIDES: "${{ inputs.debug_guides && '1' || '0' }}"
      DEBUG_MEASURES: "${{ inputs.debug_measures && '1' || '0' }}"
      DEBUG_GUIDES_DUMP_INTERS: "${{ inputs.debug_dump_inters && '1' || '0' }}"

      # Optional filters (blank means no filter; sheet can be auto-picked below)
      DEBUG_SHEET: "${{ inputs.debug_sheet }}"
      DEBUG_STAFF: "${{ inputs.debug_staff }}"
      DEBUG_MEASURES_SYS: "${{ inputs.debug_measures_sys }}"

    permissions:
      contents: read
      id-token: write

    steps:
      #################################################################
      # 1) Checkout + Auth
      #################################################################
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          version: ">= 363.0.0"

      - name: Show inputs
        run: |
          set -euo pipefail
          echo "Input PDF: ${{ inputs.pdf_gcs_uri }}"
          echo "Output prefix: ${OUTPUT_PREFIX}"
          echo "DEBUG_GUIDES=${DEBUG_GUIDES}"
          echo "DEBUG_MEASURES=${DEBUG_MEASURES}"
          echo "DEBUG_GUIDES_DUMP_INTERS=${DEBUG_GUIDES_DUMP_INTERS}"
          echo "DEBUG_SHEET=${DEBUG_SHEET}"
          echo "DEBUG_STAFF=${DEBUG_STAFF}"
          echo "DEBUG_MEASURES_SYS=${DEBUG_MEASURES_SYS}"

      #################################################################
      # 2) Clean output prefix (safe)
      #################################################################
      - name: Wipe old outputs
        run: |
          set -euo pipefail
          echo "Deleting all objects under: ${OUTPUT_PREFIX}"
          gsutil -m rm -r "${OUTPUT_PREFIX}/**" || echo "No objects to delete"

      #################################################################
      # 3) Download input PDF
      #################################################################
      - name: Download input PDF
        run: |
          set -euo pipefail
          mkdir -p /tmp/work
          gsutil cp "${{ inputs.pdf_gcs_uri }}" /tmp/work/input.pdf
          ls -lh /tmp/work/input.pdf

      #################################################################
      # 4) Run Audiveris OMR
      #################################################################
      - name: Run Audiveris OMR
        run: |
          set -euo pipefail
          mkdir -p /tmp/work/audiveris_out
          docker pull toprock/audiveris:latest

          docker run --rm \
            -v /tmp/work:/work \
            toprock/audiveris:latest \
            /audiveris-extract/bin/Audiveris -batch -export -output /work/audiveris_out /work/input.pdf || true

          # Fail fast if we didn't get an .omr
          test -f /tmp/work/audiveris_out/input/input.omr

      #################################################################
      # 5) Auto-pick DEBUG_SHEET if debugging is enabled and sheet is blank/invalid
      #################################################################
      - name: Auto-pick DEBUG_SHEET (only when debug enabled)
        if: ${{ env.DEBUG_GUIDES == '1' || env.DEBUG_MEASURES == '1' }}
        run: |
          set -euo pipefail
          OMR="/tmp/work/audiveris_out/input/input.omr"

          if [[ -z "${DEBUG_SHEET:-}" ]] || ! unzip -l "$OMR" | awk '{print $4}' | grep -qx "${DEBUG_SHEET}"; then
            SHEET="$(unzip -l "$OMR" | awk '{print $4}' | grep -E '^sheet#[0-9]+/sheet#[0-9]+\.xml$' | sort -V | head -n 1)"
            echo "Auto DEBUG_SHEET=${SHEET}"
            echo "DEBUG_SHEET=${SHEET}" >> "${GITHUB_ENV}"
          else
            echo "Using provided DEBUG_SHEET=${DEBUG_SHEET}"
          fi

      #################################################################
      # 6) Python deps
      #################################################################
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install opencv-python==4.12.0.88 pymupdf==1.20.0 numpy

      #################################################################
      # 7) Annotate PDF (guides + measure numbers)
      #################################################################
      - name: Annotate PDF from Audiveris OMR
        env:
          DEBUG_GUIDES: "${{ env.DEBUG_GUIDES }}"
          DEBUG_GUIDES_SHEET: "${{ env.DEBUG_SHEET }}"
          DEBUG_GUIDES_STAFF_ID: "${{ env.DEBUG_STAFF }}"
          DEBUG_GUIDES_DUMP_INTERS: "${{ env.DEBUG_GUIDES_DUMP_INTERS }}"

          DEBUG_MEASURES: "${{ env.DEBUG_MEASURES }}"
          DEBUG_MEASURES_SHEET: "${{ env.DEBUG_SHEET }}"
          DEBUG_MEASURES_SYS_ID: "${{ env.DEBUG_MEASURES_SYS }}"
        run: |
          set -euo pipefail

          # Tee output so you get logs both in Actions UI and as a file we upload to GCS
          python -u parser-api/annotate_guides_from_omr.py \
            /tmp/work/input.pdf \
            /tmp/work/audiveris_out/input/input.omr \
            /tmp/work/annotated.pdf | tee /tmp/work/annotate.log

          ls -lh /tmp/work/annotated.pdf /tmp/work/annotate.log

      - name: Sanity check annotated PDF page count
        run: |
          set -euo pipefail
          python - << 'PY'
          import fitz
          in_doc = fitz.open("/tmp/work/input.pdf")
          out_doc = fitz.open("/tmp/work/annotated.pdf")
          print("input pages:", in_doc.page_count)
          print("output pages:", out_doc.page_count)
          if in_doc.page_count != out_doc.page_count:
              raise SystemExit("ERROR: annotated.pdf page count does not match input.pdf")
          PY

      #################################################################
      # 8) Upload outputs
      #################################################################
      - name: Upload outputs to GCS
        run: |
          set -euo pipefail
          gsutil cp /tmp/work/annotated.pdf "${OUTPUT_PREFIX}/annotated.pdf"
          gsutil cp /tmp/work/annotate.log "${OUTPUT_PREFIX}/annotate.log"

          # Upload Audiveris outputs (useful for later debugging)
          if [ -d /tmp/work/audiveris_out ] && [ "$(ls -A /tmp/work/audiveris_out)" ]; then
            gsutil -m cp -r /tmp/work/audiveris_out "${OUTPUT_PREFIX}/audiveris_out"
          fi

          echo "All uploads complete"
