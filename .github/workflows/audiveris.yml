name: Audiveris OMR + Barline Detection Test

on:
  workflow_dispatch:
    inputs:
      pdf_gcs_uri:
        description: "GCS URI of the input PDF"
        required: true
      output_gcs_prefix:
        description: "GCS prefix where outputs will be stored (e.g., gs://omr-output/jobs/123/)"
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  run-omr-barline-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

    - name: Set up Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v3
      with:
        version: '>= 416.0.0'

    - name: Prepare workspace
      run: |
        mkdir -p input output audiveris/input audiveris/output

    - name: Download input PDF
      run: |
        echo "Downloading ${{ github.event.inputs.pdf_gcs_uri }}"
        gsutil cp "${{ github.event.inputs.pdf_gcs_uri }}" input/input.pdf

    - name: Run Audiveris
      run: |
        mv input/input.pdf audiveris/input/
        docker pull toprock/audiveris
        docker run --rm \
          -v "$(pwd)/audiveris/input":/input \
          -v "$(pwd)/audiveris/output":/output \
          toprock/audiveris

    - name: Install Python (for postprocessing)
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install numpy==1.26.4
        python -m pip install opencv-python==4.8.0.74 pymupdf==1.20.0

    - name: Run barline detection and generate annotated PDF
      run: |
        python parser-api/detect_barlines_test.py audiveris/input/input.pdf \
          --output-dir output

    - name: Upload raw Audiveris output
      run: |
        gsutil -m cp -r audiveris/output "${{ github.event.inputs.output_gcs_prefix }}/audiveris/"

    - name: Upload annotated PDF
      run: |
        gsutil cp output/annotated.pdf "${{ github.event.inputs.output_gcs_prefix }}/annotated.pdf"

    - name: Upload measures JSON
      run: |
        gsutil cp output/measures.json "${{ github.event.inputs.output_gcs_prefix }}/measures.json"
