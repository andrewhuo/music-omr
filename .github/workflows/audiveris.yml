name: Audiveris OMR + Barline Detection Test

on:
  workflow_dispatch:
    inputs:
      pdf_gcs_uri:
        description: "GCS URI to your input PDF (gs://music-omr-bucket-777135743132/input/test.pdf)"
        required: true
        type: string
      output_gcs_prefix:
        description: "GCS prefix to upload output (gs://music-omr-bucket-777135743132/output)"
        required: true
        type: string

jobs:
  pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      #################################################################
      # 1) Checkout and authenticate
      #################################################################
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          version: ">= 363.0.0"

      - name: Show inputs
        run: |
          echo "Input PDF: ${{ inputs.pdf_gcs_uri }}"
          echo "Output prefix: ${{ inputs.output_gcs_prefix }}"

      #################################################################
      # 2) Wipe everything except input/ and output/ in the main bucket
      #################################################################
      - name: Wipe non-input/output prefixes in main bucket
        shell: bash
        run: |
          set -euo pipefail

          BUCKET="gs://music-omr-bucket-777135743132"
          KEEP_INPUT="${BUCKET}/input/"
          KEEP_OUTPUT="${BUCKET}/output/"

          echo "Bucket: ${BUCKET}"
          echo "Keeping: ${KEEP_INPUT}"
          echo "Keeping: ${KEEP_OUTPUT}"
          echo "Listing top-level entries..."

          # Top-level listing (prefixes and any root objects)
          mapfile -t ITEMS < <(gsutil ls -d "${BUCKET}/*" 2>/dev/null || true)

          if [[ ${#ITEMS[@]} -eq 0 ]]; then
            echo "No top-level entries found (or none visible)."
            exit 0
          fi

          echo "Top-level entries:"
          printf '  %s\n' "${ITEMS[@]}"

          for ITEM in "${ITEMS[@]}"; do
            # Keep only input/ and output/
            if [[ "$ITEM" == "$KEEP_INPUT" || "$ITEM" == "$KEEP_OUTPUT" ]]; then
              echo "KEEP   $ITEM"
              continue
            fi

            echo "DELETE $ITEM"

            # If it's a "prefix" (ends with /), delete everything under it.
            # The ** pattern matches all objects under that prefix.
            if [[ "$ITEM" == */ ]]; then
              gsutil -m rm -r "${ITEM}**" || true

              # Also try to remove any legacy "folder placeholder" object names, if they exist.
              gsutil rm "${ITEM}" 2>/dev/null || true
              gsutil rm "${ITEM%/}_$folder$" 2>/dev/null || true
            else
              # It's a root-level object (like the weird outputgs:// object)
              gsutil rm "$ITEM" || true
            fi
          done

          echo "Cleanup complete."


      #################################################################
      # 3) Clean output prefix (delete all previous outputs)
      #################################################################
      - name: Wipe old outputs
        run: |
          set -euo pipefail
          echo "Deleting all objects under: ${{ inputs.output_gcs_prefix }}"
          gsutil -m rm -r "${{ inputs.output_gcs_prefix }}/**" || echo "No objects to delete"

      #################################################################
      # 4) Download the input PDF
      #################################################################
      - name: Download input PDF
        run: |
          set -euo pipefail
          mkdir -p /tmp/work
          gsutil cp "${{ inputs.pdf_gcs_uri }}" /tmp/work/input.pdf
          echo "Input PDF:"
          ls -lh /tmp/work/input.pdf

      #################################################################
      # 5) Run Audiveris OMR 
      #################################################################
      - name: Run Audiveris OMR
        run: |
          set -euo pipefail
          mkdir -p /tmp/work/audiveris_out
          docker pull toprock/audiveris:latest

          # Use the actual executable inside the image
          docker run --rm \
            -v /tmp/work:/work \
            toprock/audiveris:latest \
            /audiveris-extract/bin/Audiveris -batch -export -output /work/audiveris_out /work/input.pdf || true

          echo "Audiveris output contents:"
          find /tmp/work/audiveris_out -maxdepth 4 -type f -print || true
          

      #################################################################
      # 6) Inspect OMR contents (debug)
      #################################################################
      - name: Inspect OMR contents (debug)
        run: |
          set -euo pipefail
          OMR="/tmp/work/audiveris_out/input/input.omr"

          echo "== List .omr archive =="
          unzip -l "$OMR" | sed -n '1,200p'

          SHEET_XML="$(unzip -l "$OMR" | awk '{print $4}' | grep -E '^sheet#.+/sheet#.+\.xml$' | head -n 1 || true)"
          if [ -z "$SHEET_XML" ]; then
            echo
            echo "No sheet XML found inside .omr (only book.xml was saved)."
            echo "Showing Audiveris log tail to diagnose:"
            LOG="$(ls -1 /tmp/work/audiveris_out/input/*.log 2>/dev/null | head -n 1 || true)"
            if [ -n "$LOG" ]; then
              echo "Log: $LOG"
              tail -n 200 "$LOG" || true
            else
              echo "No log file found in /tmp/work/audiveris_out/input/"
            fi
            exit 0
          fi

          echo
          echo "== Found sheet XML: $SHEET_XML =="
          unzip -p "$OMR" "$SHEET_XML" | sed -n '1,200p'

          echo
          echo "== Grep likely geometry keywords =="
          unzip -p "$OMR" "$SHEET_XML" | egrep -n "System|Staff|bounds|rect|x|y|top|bottom|left|right" | head -n 200 || true

      
      #################################################################
      # 7) Python setup & dependencies
      #################################################################
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install opencv-python==4.12.0.88 pymupdf==1.20.0 numpy

      #################################################################
      # 8) Annotate measures on PDF
      #################################################################
      - name: Draw staff guides from Audiveris OMR
        run: |
          set -euo pipefail
          python -u parser-api/annotate_guides_from_omr.py \
            /tmp/work/input.pdf \
            /tmp/work/audiveris_out/input/input.omr \
            /tmp/work/annotated.pdf
          echo "Annotated PDF:"
          ls -lh /tmp/work/annotated.pdf

      #################################################################
      # 9) Render first page of annotated PDF to PNG (debug)
      #################################################################
      - name: Render debug PNG preview
        run: |
          set -euo pipefail
          mkdir -p /tmp/work/debug
          python - << 'PYCODE'
          import fitz
          doc = fitz.open("/tmp/work/annotated.pdf")
          page = doc[0]
          pix = page.get_pixmap(matrix=fitz.Matrix(2,2))
          pix.save("/tmp/work/debug/annotated_page1.png")
          doc.close()
          PYCODE
          echo "Debug PNG:"
          ls -lh /tmp/work/debug/annotated_page1.png

      #################################################################
      # 10) Upload ALL outputs to GCS
      #################################################################
      - name: Upload outputs to GCS
        run: |
          set -euo pipefail

          # Annotated PDF
          gsutil cp /tmp/work/annotated.pdf "${{ inputs.output_gcs_prefix }}/annotated.pdf"

          # Debug PNG
          gsutil -m cp -r /tmp/work/debug "${{ inputs.output_gcs_prefix }}/debug"

          # Audiveris outputs (only if present)
          if [ -d /tmp/work/audiveris_out ] && [ "$(ls -A /tmp/work/audiveris_out)" ]; then
            echo "Uploading Audiveris outputs"
            gsutil -m cp -r /tmp/work/audiveris_out "${{ inputs.output_gcs_prefix }}/audiveris_out"
          else
            echo "No Audiveris outputs to upload"
          fi

          echo "All uploads complete"
