name: Audiveris OMR + Barline Detection Test

on:
  workflow_dispatch:
    inputs:
      pdf_gcs_uri:
        description: "GCS URI to input PDF (example: gs://YOUR_BUCKET/input/job123.pdf)"
        required: true
        type: string
      output_gcs_prefix:
        description: "GCS prefix for outputs (example: gs://YOUR_BUCKET/output/job123)"
        required: true
        type: string

jobs:
  audiveris_omr_and_barlines:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Show inputs
        run: |
          echo "Input PDF: ${{ inputs.pdf_gcs_uri }}"
          echo "Output prefix: ${{ inputs.output_gcs_prefix }}"

      - name: Clean previous inputs in bucket
        run: |
          set -euo pipefail
          echo "Deleting old inputs under the input folder..."
          # Delete all objects in the input folder
          # Example: gs://bucket/input/*
          # We parse the bucket and prefix:
          uri="${{ inputs.pdf_gcs_uri }}"
          # Extract bucket (after gs:// and before first /)
          bucket=$(echo "$uri" | sed -E 's#^gs://([^/]+)/.*#\1#')
          # Extract path prefix of input folder (everything up to last /)
          prefix=$(echo "$uri" | sed -E 's#^gs://[^/]+/(.*)/[^/]+$#\1#')
          echo "Bucket: $bucket"
          echo "Prefix: $prefix"
          gsutil -m rm -r "gs://$bucket/$prefix/*" || echo "No inputs or already deleted"

      - name: Clean previous outputs in bucket
        run: |
          set -euo pipefail
          echo "Deleting old outputs under ${{ inputs.output_gcs_prefix }}/"
          gsutil -m rm -r "${{ inputs.output_gcs_prefix }}/*" || echo "No outputs to delete"

      - name: (Re)Upload input PDF
        run: |
          set -euo pipefail
          echo "Re-uploading input PDF so itâ€™s available for processing..."
          # This assumes you still have the input locally in your runner, or you can replace
          # this with whatever method you use to re-upload the input file. If not, remove
          # this step and re-upload your PDF by other means before download.
          gsutil cp "${{ inputs.pdf_gcs_uri }}" "${{ inputs.pdf_gcs_uri }}"

      - name: Download input PDF from GCS
        run: |
          set -euo pipefail
          mkdir -p /tmp/work
          echo "Downloading ${{ inputs.pdf_gcs_uri }}"
          gsutil cp "${{ inputs.pdf_gcs_uri }}" /tmp/work/input.pdf
          ls -lh /tmp/work/input.pdf

      - name: Run Audiveris OMR (Docker)
        run: |
          set -euo pipefail
          mkdir -p /tmp/work/audiveris_out
          docker pull toprock/audiveris:latest
          docker run --rm \
            -v /tmp/work:/work \
            toprock/audiveris:latest \
            audiveris -batch -export -output /work/audiveris_out /work/input.pdf || true
          echo "Audiveris output listing:"
          ls -R /tmp/work/audiveris_out || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install opencv-python==4.12.0.88 pymupdf==1.20.0 numpy

      - name: Run barline detection test
        run: |
          set -euo pipefail
          mkdir -p /tmp/work/detect_barlines_out
          python parser-api/detect_barlines_test.py /tmp/work/input.pdf --output-dir /tmp/work/detect_barlines_out
          echo "Barline detection output listing:"
          ls -R /tmp/work/detect_barlines_out

      - name: Annotate measures on PDF
        run: |
          set -euo pipefail
          python parser-api/annotate_measures.py /tmp/work/input.pdf /tmp/work/annotated.pdf
          ls -lh /tmp/work/annotated.pdf

      - name: Upload annotated PDF to GCS
        run: |
          set -euo pipefail
          gsutil -m cp /tmp/work/annotated.pdf "${{ inputs.output_gcs_prefix }}/annotated.pdf"
          echo "Uploaded: ${{ inputs.output_gcs_prefix }}/annotated.pdf"

      - name: Upload Audiveris outputs to GCS (optional)
        run: |
          set -euo pipefail
          if [ -d /tmp/work/audiveris_out ] && [ "$(ls -A /tmp/work/audiveris_out)" ]; then
            echo "Uploading Audiveris outputs:"
            gsutil -m cp -r /tmp/work/audiveris_out "${{ inputs.output_gcs_prefix }}/audiveris_out"
            echo "Uploaded Audiveris outputs to: ${{ inputs.output_gcs_prefix }}/audiveris_out"
          else
            echo "No Audiveris outputs to upload (folder missing or empty), skipping."
          fi
